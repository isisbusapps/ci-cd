name: create-gh-action-runner-image.yaml
on:
  push:

jobs:
  packer:
    runs-on: ubuntu-latest
    defaults:
      run: 
        working-directory: self-hosted-gh-runners/static/packer
    env:
      OS_CLIENT_CONFIG_FILE: ${{ github.workspace }}/clouds.yaml
      OS_CLOUD: openstack
      IMAGE_NAME: gh-action-runner-image
      BASE_IMAGE_NAME: ubuntu-noble-24.04-nogui
      FLAVOR_NAME: l3.nano
      NETWORK_NAME: Internal

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Create clouds.yaml
      run: echo "${{ secrets.OPENSTACK_CLOUDS }}" >> ${{ github.workspace }}/clouds.yaml 
    
    - name: Export Base Image & Build VM Flavor
      run: |
        echo "Export Base Image ID"
        echo $(BASE_IMAGE_ID=$(echo $(openstack image list --name "${{ env.BASE_IMAGE_NAME }}" --status "active" -f json) | jq '.[].ID')) >> $GITHUB_ENV

        echo "Export Build VM Flavor ID"
        echo $(FLAVOR_ID=$(openstack flavor show ${{ env.FLAVOR_NAME }} -f value -c id)) >> $GITHUB_ENV

        echo "Export Network ID"
        echo $(NETWORK_ID=$(openstack network show ${{ env.NETWORK_NAME }} -f value -c id)) >> $GITHUB_ENV

    - name: Test Export
      run: |
        echo "Outputting exported values"
        echo ${{ env.BASE_IMAGE_ID }}
        echo ${{ env.FLAVOR_ID }}
        echo ${{ NETWORK_ID }}
        echo "Outputted Exported Values"
    - name: Setup packer
      uses: hashicorp/setup-packer@main
      with:
        version: latest

    - name: Packer Init
      run: packer init .
    
    - name: Packer Validate
      run: packer validate .

    - name: Packer Build
      run: packer build .

    - name: Delete old images
      run: ./scripts/delete_old_images.sh