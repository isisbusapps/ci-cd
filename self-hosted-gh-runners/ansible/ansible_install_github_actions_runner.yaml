- name: Install dependencies
  hosts: runnerServer
  remote_user: ubuntu

  tasks:
    - name: Download GitHub Self-Hosted runner
      ansible.builtin.get_url:
        url: https://github.com/actions/runner/releases/download/v{{RUNNER_VERSION}}/actions-runner-linux-x64-{{RUNNER_VERSION}}.tar.gz
        dest: /home/ubuntu/FASE/actions-runner/actions-runner-linux-x64-{{RUNNER_VERSION}}.tar.gz

    - name: Change File Permissions
      ansible.builtin.file:
        path: /home/ubuntu/FASE/actions-runner/expect_start.sh
        state: touch
        mode: u=rwx,g=r,o=r
    
    - name: Change File Permissions
      ansible.builtin.file:
        path: /home/ubuntu/FASE/actions-runner/configure.sh
        state: touch
        mode: u=rwx,g=r,o=r

    - name: Extract & Configure the runner
      ansible.builtin.command:
        argv:
          - /home/ubuntu/FASE/actions-runner/configure.sh
          - "{{ACCESS_TOKEN}}"
          - "{{ORG}}"
          - "{{RUNNER_VERSION}}"

    - name: Install Runner Service
      become: true
      ansible.builtin.command:
        chdir: /home/ubuntu/FASE/actions-runner/
        argv:
          - ./svc.sh
          - install
    
    - name: Start Runner Service
      become: true
      ansible.builtin.command:
        chdir: /home/ubuntu/FASE/actions-runner/
        argv:
          - ./svc.sh
          - start